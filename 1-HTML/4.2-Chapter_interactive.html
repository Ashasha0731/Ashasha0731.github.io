<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>章節測驗</title>
    <link rel="icon" type="image/png" href="../0-IMAGE/0_Nav/logo-遊戲廳.png">    <!-- 網站圖標設定 -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>  <!-- 先在 <head> 加入 SheetJS -->
    <style>
/* ==================== 全域樣式 ==================== */
        body{
            font-family: "微軟正黑體", sans-serif;
            background: #0a0a0a;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background-image: url('../0-IMAGE/1_Guide-page/星空背景.gif');
            background-size: cover;       /* 覆蓋整個容器 */
            background-repeat: repeat; /* 重複方便滾動 */
            animation: move-bg 60s linear infinite;
        }

        @keyframes move-bg {
            0% { background-position: 0 0; }
            100% { background-position: -5000px 0; } /* 往左移動 */
        }

/* ==================== 導覽列 ====================== */
        #header-container {
            position: fixed; /* 固定在螢幕頂端 */
            top: 0;
            left: 0;
            width: 100%;
            height: 60px; /* 導覽列高度 */
            background-color: #333;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);/* 懸浮感陰影 */
        }

/* =================== 返回上一頁 ===================== */
        /* 左上角返回按鈕 */
        .back-btn {
            position: fixed;
            top: 95px;
            left: 20px;
            z-index: 2000;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: 2px solid white;
            padding: 12px 18px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(250, 247, 247, 0.978);
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.05);
        }

/* =================== 章節標題 ===================== */
        .chapter-img1{
            width: 250px;           /* 讓圖片比螢幕大 */
            height: 40px;
            position: fixed;
            left: 0px;
            top: 100px;
            z-index: 101;
            filter: drop-shadow(0px 0px 5px #ffffff);     /*增加符合PNG的陰影*/
            transition: transform 0.3s ease; /* 平滑過渡 */
        }

        .chapter-title1 {    /*章節*/
            font-size: 30px;
            position: fixed;
            top: 100px;
            left: 110px;
            z-index: 102;
            color: rgb(255, 255, 255);
            text-shadow: 
                0 0 5px #fff,
                0 0 20px rgb(0, 0, 0);
            font-family: "微軟正黑體", sans-serif;
            display: block;          /* 確保可被置中 */
            width: 100%;             /* 可選，保證占滿橫向置中 */
        }

        .chapter-img2{
            width: 600px;           /* 讓圖片比螢幕大 */
            height: 80px;
            position: fixed;
            left: 0px;
            top: 80px;
            filter: drop-shadow(0px 0px 10px #ffffffae);     /*增加符合PNG的陰影*/
            transition: transform 0.3s ease; /* 平滑過渡 */
        }

        .chapter-title2 {    /*章節*/
            font-size: 40px;
            position: fixed;
            top: 90px;
            left: 250px;
            z-index: 100;
            color: rgb(255, 255, 255);
            text-shadow: 
                0 0 5px #fff,
                0 0 10px rgb(0, 0, 0),
                0 0 20px rgb(0, 0, 0);
            font-family: "微軟正黑體", sans-serif;
            display: block;          /* 確保可被置中 */
            width: 100%;             /* 可選，保證占滿橫向置中 */
        }

/* ==================== 測驗 ====================== */
        .quiz-container {
            max-width: 1000px;
            width: 1000px;
            background: #111;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .question { margin-bottom: 20px; }
        .options {
            display: flex;
            gap: 20px; /* 選項間距 */
        }
        .options label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        input[type="radio"] { margin-right: 10px; }
        input[type="text"] { width: 100%; padding: 8px; border-radius: 8px; border: none; }
        button {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            background: #1a73e8;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background: #1664c1; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #222;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
        }
        .modal-content button { margin-top: 15px; }

        /* 問答題初始隱藏 */
        #open-answer-container { display: none; margin-top: 20px; }


/* ===================== 章節按鈕 =================== */
        .img-GOsimulation{
            width: 400px;          
            height: auto;
            position: fixed;
            right: -1px;
            bottom: 20px;
            z-index: 5000;
            filter: drop-shadow(0px 0px 10px #ffffffae);     /*增加符合PNG的陰影*/
            transition: transform 0.3s ease; /* 平滑過渡 */
        }

        .img-GoChapter{
            width: 250px;           /* 讓圖片比螢幕大 */
            height: auto;
            position: fixed;
            right: 10px;
            bottom: 100px;
            z-index: 5001;
            filter: drop-shadow(0px 0px 10px #ffffffae);     /*增加符合PNG的陰影*/
            transition: transform 0.3s ease; /* 平滑過渡 */
        }

        .img-GOinteractive:hover{
            transform: scale(1.1) rotate(20deg); /* 保持旋轉角度同時放大 */
        }

        .img-download:hover{
            transform: scale(1.1) rotate(20deg); /* 保持旋轉角度同時放大 */
        }


/* ===================== 底列 =================== */
        .footer {
            width: 100%;
            height: 50px; /* 高一點更舒適 */
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 1000;

            /* 漸層 + 半透明 + 毛玻璃 */
            background: linear-gradient(120deg, rgba(9,9,9,0.4), rgba(39,40,46,0.6), rgba(15,15,15,0.8));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid rgba(255,255,255,0.2); /* 頂部細邊框增加層次 */

            /* 文字樣式 */
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);

            /* 置中 */
            display: flex;
            justify-content: center;
            align-items: center;

            /* 動態光暈（可選） */
            box-shadow: 0 0 15px rgba(255,255,255,0.2) inset;
        }

    </style>
</head>

<!--------------------------- html ----------------------------->
<body>
    <!-- 導覽列 -->
    <header>
        <div id="header-container"></div>
        <button class="back-btn" onclick="enterBack()">返回</button>
        <!-- 章節標題 -->
        <div>
            <img class="chapter-img1" src="../0-IMAGE/4-Game-Chapter/章節旗幟1.png" alt="章節旗幟">
            <span class="chapter-title1">第一章  ​  ​  ​ </span>
        </div>
        <div>
            <img class="chapter-img2" src="../0-IMAGE/4-Game-Chapter/章節旗幟-測驗.png" alt="章節旗幟">
            <span class="chapter-title2">網頁安全探索</span>
        </div>
    </header>
    
    <!-- 主頁面 -->
    <main style="margin-top: 150px;">
        <h2 style="font-size: 36px; text-align: center; margin-bottom: 10px;">章節測驗</h2>
        <div class="quiz-container"></div>

        <!-- 意見回復 -->
        <div id="feedback-container" style="display:none; margin-top:20px;">
            <h3>意見回復：請寫下你對本章測驗的建議或心得</h3>
            <input type="text" id="feedback-input" placeholder="請輸入你的意見或回饋(如:無填⌈無⌋)" />
            <button id="submit-feedback" style="margin-top:10px;">送出回覆</button>
            <p id="feedback-msg" style="color:#ff9090;"></p>
            <div style="height:100px;">.</div>
        </div>

        <!-- Modal -->
        <div class="modal" id="result-modal">
            <div class="modal-content">
                <p id="modal-text"></p>
                <button id="retry-btn">繼續回答 問答題 </button>
            </div>
        </div>
    </main>

    <!-- 章節細項按鈕 -->
    <div>
        <!-- 前往實境模擬區 -->
        <a href="4.3-Chapter_simulation.html">
            <img class="img-GOsimulation" src="../0-IMAGE/4-Game-Chapter/4-2/前往互動測驗.png" alt="前往互動測驗區">
        </a>
    </div>



    <!-- 頁尾 -->
    <footer class="footer">
        <!-- 可放文字或按鈕 -->
        <span >© 2025 中學生資訊安全網</span>
    </footer>



<!---------------------------- JS ------------------------------>
    
    <script>
        //載入導覽列
        fetch('./0_Nav-2.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header-container').innerHTML = data;
        })
        .catch(error => {
            console.error('載入 HTML 失敗:', error);
        });

       //綁定URL參數
        const params = new URLSearchParams(window.location.search);
        const title = params.get('title');      // ex: "第一章"
        const subtitle = params.get('subtitle'); // ex: "系統安全是什麼？"
        console.log(title, subtitle); // 確認使用的資料

        // 更新章節標題
        const t1 = document.querySelector('.chapter-title1');
        const t2 = document.querySelector('.chapter-title2');
        if (t1) t1.textContent = title || t1.textContent;
        if (t2) t2.textContent = subtitle || t2.textContent;

        // Excel 相對路徑
        const excelPath = "../4-Teaching/2-Ch_questions.xlsx";

        // 讀取 Excel
        fetch(excelPath).then(res=>res.arrayBuffer())
        .then(data=>{
            const wb = XLSX.read(data,{type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            // 過濾該章節題目
            const chapterQs = jsonData.filter(row=>row.Chapter===title);

            const quizContainer = document.querySelector('.quiz-container');
            quizContainer.innerHTML = '';

            chapterQs.forEach((q, idx)=>{
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.setAttribute('data-answer', q.Answer); // 正確答案欄位

                let optionsHtml = '';
                ['OptionA','OptionB','OptionC','OptionD'].forEach(opt=>{
                    if(q[opt]){
                        optionsHtml += `<label><input type="radio" name="q${idx+1}" value="${opt.slice(-1).toLowerCase()}"> ${q[opt]}</label>`;
                    }
                });

                questionDiv.innerHTML = `<h3>${idx+1}. ${q.Question}</h3><div class="options">${optionsHtml}</div>`;
                quizContainer.appendChild(questionDiv);
            });

            // 在讀取題目後初始化錯誤次數
            const questionErrors = []; // 陣列記錄每題錯誤次數
            chapterQs.forEach((q, idx) => {
                questionErrors[idx] = 0; // 初始錯誤次數 0
            });

            // 加入提交按鈕
            quizContainer.insertAdjacentHTML('beforeend','<button id="submit-single">提交單選題</button>');


            // 綁定單選題提交事件
            const submitSingleBtn = document.getElementById("submit-single");
            const modal = document.getElementById("result-modal");
            const modalText = document.getElementById("modal-text");
            const openContainer = document.getElementById("open-answer-container");

            submitSingleBtn.addEventListener("click", ()=> {
                const questions = document.querySelectorAll(".question[data-answer]");
                let correctCount = 0;

                questions.forEach((q, idx)=>{
                    const selected = q.querySelector('input[type="radio"]:checked');
                    const answer = q.getAttribute("data-answer").trim().toLowerCase();

                    // 先移除之前的提示 span（避免重複）
                    let statusSpan = q.querySelector(".status-text");
                    if(!statusSpan){
                        statusSpan = document.createElement("span");
                        statusSpan.className = "status-text";
                        statusSpan.style.marginLeft = "24px";
                        statusSpan.style.fontSize = "16px";
                        q.querySelector("h3").appendChild(statusSpan);
                    }

                    if(selected && selected.value.toLowerCase() === answer){
                        correctCount++;
                        q.dataset.correct = "true";

                        // 文字顯示 [正確] 並綠色
                        statusSpan.textContent = "[正確]";
                        statusSpan.style.color = "limegreen";

                        // 鎖定答對後不允許修改
                        const radios = q.querySelectorAll('input[type="radio"]');
                        radios.forEach(radio=>{
                            if(radio.value.toLowerCase() !== answer){
                                radio.disabled = true; // 禁用其他錯誤選項
                            }
                            // 正確選項保持可選，但用 CSS 鎖定更改（可保留選中）
                            radio.addEventListener('click', (e)=>{
                                if(q.dataset.correct === "true"){
                                    e.preventDefault(); // 阻止改動
                                    radio.checked = true; // 保持選中
                                }
                            });
                        });

                        // 顯示文字：綠色正確 + 綠色錯誤次數（如果有）
                        if (questionErrors[idx] > 0) {
                            statusSpan.innerHTML = `<span style="color:limegreen;">[正確]</span> <span style="color:limegreen;">${questionErrors[idx]} 次錯誤</span>`;
                        } else {
                            statusSpan.textContent = "[正確]";
                            statusSpan.style.color = "limegreen";
                        }

                    } else {
                        // 錯誤次數累加
                        questionErrors[idx]++;
                        // 顯示紅色錯誤次數
                        statusSpan.textContent = `[錯誤]${questionErrors[idx]} 次錯誤`;
                        statusSpan.style.color = "red";
                    }
                });

                modalText.innerHTML = `你答對了 ${correctCount} / ${questions.length} 題`;
                modal.style.display = "flex";

                if (correctCount === questions.length) {
                    submitSingleBtn.style.display = "none";

                    const feedbackContainer = document.getElementById("feedback-container");
                    feedbackContainer.style.display = "block";

                    const submitFeedbackBtn = document.getElementById("submit-feedback");
                    submitFeedbackBtn.addEventListener("click", () => {
                        const feedbackInput = document.getElementById("feedback-input");
                        const feedback = feedbackInput.value.trim();

                        if (feedback.length < 1) {
                            document.getElementById("feedback-msg").textContent = "請至少輸入一個字！";
                            return;
                        }

                        window.feedbackResult = feedback;
                        document.getElementById("feedback-msg").textContent = "";

                        // 改成「查看答題狀態」
                        submitFeedbackBtn.textContent = "查看答題狀態";

                        // 查看答題狀態功能
                        submitFeedbackBtn.onclick = () => {
                            let statusText = "<h3>答題狀態</h3>";
                            chapterQs.forEach((q, idx) => {
                                const color = questionErrors[idx] === 0 ? "white" : "red";
                                statusText += `<p>Q${idx + 1}: <span style="color:${color};">${questionErrors[idx]} 次錯誤</span></p>`;
                            });
                            statusText += `<p>你的意見回覆：${window.feedbackResult}</p>`;
                            modalText.innerHTML = statusText;
                            modal.style.display = "flex";
                        };
                    });
                }
            });

            document.getElementById("retry-btn").addEventListener("click", ()=>{
                modal.style.display = "none";
            }).catch(err=>console.error("讀取 Excel 失敗:",err));
        });

        // ▶返回按鈕： （保留原先參數）
        function enterBack() {
            const encodedTitle = encodeURIComponent(title || '');
            const encodedSubtitle = encodeURIComponent(subtitle || '');
            window.location.href = `4-Game-Chapter.html?title=${encodedTitle}&subtitle=${encodedSubtitle}`;
        }
    </script>
</body>
</html>